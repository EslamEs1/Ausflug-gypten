{% extends 'base.html' %}
{% load i18n %}

{% block title %}
<title>{% trans "Galerie" %} | AusflugÄgypten</title>
{% endblock title %}

{% block content %}
  <main>
    <!-- Hero Section with Ripple Effect -->
    <section class="relative bg-cover bg-center overflow-hidden" style="height: {% if page_hero %}{{ page_hero.height }}{% else %}450px{% endif %}; background-image: linear-gradient(rgba(36, 93, 129, {% if page_hero %}{{ page_hero.overlay_opacity }}{% else %}0.8{% endif %}), rgba(200, 166, 110, 0.6)), url('{% if page_hero and page_hero.background_image %}{{ page_hero.background_image.url }}{% elif featured_images.first.image %}{{ featured_images.first.image.url }}{% else %}/static/img/hero/hurghada.jpg{% endif %}');">
      
      <!-- Animated Ripple Circles -->
      <div class="absolute inset-0 overflow-hidden">
        <div class="ripple-circle absolute w-96 h-96 bg-white/5 rounded-full -top-20 -left-20 animate-ripple-1"></div>
        <div class="ripple-circle absolute w-80 h-80 bg-white/5 rounded-full top-40 -right-20 animate-ripple-2"></div>
        <div class="ripple-circle absolute w-64 h-64 bg-primary-gold/10 rounded-full bottom-20 left-1/4 animate-ripple-3"></div>
      </div>
      
      <div class="relative z-10 h-full flex items-center">
        <div class="container mx-auto px-4">
          <div class="max-w-3xl">
            <div class="breadcrumb mb-6 text-white">
              <a href="{% url 'core:home' %}" class="hover:text-primary-gold">{% trans "Home" %}</a>
              <span class="breadcrumb-separator">/</span>
              <span>{% if page_hero and page_hero.breadcrumb_text %}{{ page_hero.breadcrumb_text }}{% else %}{% trans "Galerie" %}{% endif %}</span>
            </div>
            <h1 class="text-white font-heading font-bold mb-6 animate-fade-in text-4xl md:text-5xl">{% if page_hero %}{{ page_hero.title }}{% else %}{% trans "Galerie" %}{% endif %}</h1>
            <p class="text-white text-xl mb-8 animate-slide-up">{% if page_hero %}{{ page_hero.subtitle }}{% else %}{% trans "Entdecken Sie die Schönheit Ägyptens in unseren Fotos" %}{% endif %}</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Gallery Filters -->
    <section class="py-8 bg-gray-50">
      <div class="container mx-auto px-4">
        <div class="flex flex-wrap gap-4 justify-center">
          <button class="filter-btn {% if not current_category %}active{% endif %}" data-filter="all" onclick="filterGallery('all')">
            {% trans "Alle" %}
          </button>
          {% for category in categories %}
          <button class="filter-btn {% if current_category == category.slug %}active{% endif %}" data-filter="{{ category.slug }}" onclick="filterGallery('{{ category.slug }}')">
            {% if category.icon %}{{ category.icon }}{% endif %} {{ category.name }}
          </button>
          {% endfor %}
        </div>
      </div>
    </section>

    <!-- Gallery Grid -->
    <section class="py-16 bg-white">
      <div class="container mx-auto px-4">
        {% if images %}
        <div class="gallery-grid grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
          {% for image in images %}
          <div class="gallery-item group" data-category="{% if image.category %}{{ image.category.slug }}{% else %}all{% endif %}" data-image-id="{{ image.id }}">
            <div class="gallery-image-wrapper relative overflow-hidden rounded-xl cursor-pointer" onclick="openLightbox({{ image.id }}, '{{ image.image.url }}', '{{ image.title|escapejs }}', '{{ image.description|escapejs|default:"" }}')">
              <img src="{{ image.image.url }}" alt="{{ image.alt_text|default:image.title }}" class="gallery-image w-full h-64 object-cover transform group-hover:scale-110 transition-transform duration-500" loading="lazy">
              <div class="gallery-overlay absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
              <div class="gallery-info absolute bottom-0 left-0 right-0 p-4 text-white transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300 opacity-0 group-hover:opacity-100">
                <h3 class="font-heading font-bold mb-1">{{ image.title }}</h3>
                {% if image.location %}
                  <p class="text-sm text-gray-200">{{ image.location.name }}</p>
                {% elif image.category %}
                  <p class="text-sm text-gray-200">{{ image.category.name }}</p>
                {% endif %}
              </div>
              <div class="gallery-icon absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                <div class="w-16 h-16 bg-white/90 backdrop-blur-sm rounded-full flex items-center justify-center">
                  <svg class="w-8 h-8 text-primary-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/>
                  </svg>
                </div>
              </div>
              {% if image.is_featured %}
                <span class="badge-featured absolute top-4 left-4">{% trans "Hervorgehoben" %}</span>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>

        <!-- Pagination -->
        {% if is_paginated %}
        <div class="flex justify-center items-center gap-2 mt-12">
          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if current_category %}&category={{ current_category }}{% endif %}{% if current_location %}&location={{ current_location }}{% endif %}" class="pagination-btn-modern">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
              </svg>
            </a>
          {% endif %}
          
          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <button class="pagination-btn-modern active">{{ num }}</button>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <a href="?page={{ num }}{% if current_category %}&category={{ current_category }}{% endif %}{% if current_location %}&location={{ current_location }}{% endif %}" class="pagination-btn-modern">{{ num }}</a>
            {% endif %}
          {% endfor %}
          
          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if current_category %}&category={{ current_category }}{% endif %}{% if current_location %}&location={{ current_location }}{% endif %}" class="pagination-btn-modern">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </a>
          {% endif %}
        </div>
        {% endif %}

        {% else %}
        <div class="text-center py-12">
          <p class="text-gray-600 text-lg mb-4">{% trans "Keine Bilder gefunden." %}</p>
        </div>
        {% endif %}
      </div>
    </section>
  </main>

  <!-- Lightbox Modal -->
  <div id="lightboxModal" class="lightbox-modal hidden">
    <div class="lightbox-overlay" onclick="closeLightbox()"></div>
    <div class="lightbox-content">
      <button class="lightbox-close" onclick="closeLightbox()" aria-label="{% trans 'Lightbox schließen' %}">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
      <button class="lightbox-prev" onclick="prevImage()" aria-label="{% trans 'Vorheriges Bild' %}">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
      </button>
      <button class="lightbox-next" onclick="nextImage()" aria-label="{% trans 'Nächstes Bild' %}">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </button>
      <img id="lightboxImage" src="" alt="{% trans 'Galeriebild' %}" class="lightbox-image">
      <div class="lightbox-info">
        <h3 id="lightboxTitle" class="font-heading font-bold text-white text-xl"></h3>
        <p id="lightboxDescription" class="text-gray-200"></p>
      </div>
    </div>
  </div>

  <script>
    let currentImageIndex = 0;
    let allImages = [];
    
    // Initialize images array from page
    document.addEventListener('DOMContentLoaded', function() {
      const galleryItems = document.querySelectorAll('.gallery-item');
      allImages = Array.from(galleryItems).map(item => ({
        id: item.dataset.imageId,
        src: item.querySelector('img').src,
        title: item.querySelector('.gallery-info h3')?.textContent || '',
        description: item.querySelector('.gallery-info p')?.textContent || ''
      }));
    });

    function filterGallery(category) {
      const url = new URL(window.location);
      if (category === 'all') {
        url.searchParams.delete('category');
      } else {
        url.searchParams.set('category', category);
      }
      url.searchParams.delete('page'); // Reset to first page
      window.location.href = url.toString();
    }

    function openLightbox(imageId, imageSrc, title, description) {
      const modal = document.getElementById('lightboxModal');
      const img = document.getElementById('lightboxImage');
      const titleEl = document.getElementById('lightboxTitle');
      const descEl = document.getElementById('lightboxDescription');
      
      // Find current image index
      currentImageIndex = allImages.findIndex(img => img.id === imageId.toString());
      if (currentImageIndex === -1) currentImageIndex = 0;
      
      img.src = imageSrc;
      titleEl.textContent = title;
      descEl.textContent = description;
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      const modal = document.getElementById('lightboxModal');
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }

    function prevImage() {
      if (allImages.length === 0) return;
      currentImageIndex = (currentImageIndex - 1 + allImages.length) % allImages.length;
      const img = allImages[currentImageIndex];
      document.getElementById('lightboxImage').src = img.src;
      document.getElementById('lightboxTitle').textContent = img.title;
      document.getElementById('lightboxDescription').textContent = img.description;
    }

    function nextImage() {
      if (allImages.length === 0) return;
      currentImageIndex = (currentImageIndex + 1) % allImages.length;
      const img = allImages[currentImageIndex];
      document.getElementById('lightboxImage').src = img.src;
      document.getElementById('lightboxTitle').textContent = img.title;
      document.getElementById('lightboxDescription').textContent = img.description;
    }

    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
      const modal = document.getElementById('lightboxModal');
      if (modal.classList.contains('hidden')) return;
      
      if (e.key === 'Escape') {
        closeLightbox();
      } else if (e.key === 'ArrowLeft') {
        prevImage();
      } else if (e.key === 'ArrowRight') {
        nextImage();
      }
    });
  </script>
{% endblock content %}
